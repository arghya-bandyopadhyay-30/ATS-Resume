worker_processes auto;

events
{
	worker_connections 4096;
}

stream
{
	ssl_preread on;
	tcp_nodelay on;

	map $ssl_preread_server_name $is_http_sni
	{	
		owleyealerts.cloud 1;
		~^.+\.secured\.owleyealerts\.cloud$ 2;
		~^.+\.basic\.owleyealerts\.cloud$ 3;
		default 0;
	}

	map $ssl_preread_alpn_protocols $is_http_alpn
	{
		"http/1.1" 1;
		"h2" 1;
		default 0;
	}

	map "$is_http_sni$is_http_alpn" $backend
	{	
		21 sni_tcp_secured_backend;
		20 sni_tcp_secured_backend;
		31 sni_tcp_basic_backend;
		30 sni_tcp_basic_backend;
		11 http_web_backend; # Both matched
		10 http_web_backend; # Only SNI matched
		01 http_web_backend; # Only ALPN matched
		default tcp_tunnel_rathole_server_backend;
	}

	upstream http_web_backend
	{
		server tunnel-nginx:6443;
	}

	upstream tcp_tunnel_rathole_server_backend
	{
		server tunnel-rathole-server:2333;
	}

	upstream sni_tcp_basic_backend
	{
		server tunnel-streamer:3000;
		server tunnel-streamer:3001;
		server tunnel-streamer:3002;
		server tunnel-streamer:3003;
		server tunnel-streamer:3004;
		server tunnel-streamer:3005;
		server tunnel-streamer:3006;
		server tunnel-streamer:3007;
		server tunnel-streamer:3008;
		server tunnel-streamer:3009;
		server tunnel-streamer:3010;
		server tunnel-streamer:3011;
		server tunnel-streamer:3012;
		server tunnel-streamer:3013;
		server tunnel-streamer:3014;
		server tunnel-streamer:3015;
		server tunnel-streamer:3016;
		server tunnel-streamer:3017;
		server tunnel-streamer:3018;
		server tunnel-streamer:3019;
		server tunnel-streamer:3020;
		server tunnel-streamer:3021;
		server tunnel-streamer:3022;
		server tunnel-streamer:3023;
		server tunnel-streamer:3024;
		server tunnel-streamer:3025;
		server tunnel-streamer:3026;
		server tunnel-streamer:3027;
		server tunnel-streamer:3028;
		server tunnel-streamer:3029;
		server tunnel-streamer:3030;
		server tunnel-streamer:3031;
		server tunnel-streamer:3032;
		server tunnel-streamer:3033;
		server tunnel-streamer:3034;
		server tunnel-streamer:3035;
		server tunnel-streamer:3036;
		server tunnel-streamer:3037;
		server tunnel-streamer:3038;
		server tunnel-streamer:3039;
		server tunnel-streamer:3040;
		server tunnel-streamer:3041;
		server tunnel-streamer:3042;
		server tunnel-streamer:3043;
		server tunnel-streamer:3044;
		server tunnel-streamer:3045;
		server tunnel-streamer:3046;
		server tunnel-streamer:3047;
		server tunnel-streamer:3048;
		server tunnel-streamer:3049;
		server tunnel-streamer:3050;
		server tunnel-streamer:3051;
		server tunnel-streamer:3052;
		server tunnel-streamer:3053;
		server tunnel-streamer:3054;
		server tunnel-streamer:3055;
		server tunnel-streamer:3056;
		server tunnel-streamer:3057;
		server tunnel-streamer:3058;
		server tunnel-streamer:3059;
		server tunnel-streamer:3060;
		server tunnel-streamer:3061;
		server tunnel-streamer:3062;
		server tunnel-streamer:3063;
		server tunnel-streamer:3064;
		server tunnel-streamer:3065;
		server tunnel-streamer:3066;
		server tunnel-streamer:3067;
		server tunnel-streamer:3068;
		server tunnel-streamer:3069;
		server tunnel-streamer:3070;
		server tunnel-streamer:3071;
		server tunnel-streamer:3072;
		server tunnel-streamer:3073;
		server tunnel-streamer:3074;
		server tunnel-streamer:3075;
		server tunnel-streamer:3076;
		server tunnel-streamer:3077;
		server tunnel-streamer:3078;
		server tunnel-streamer:3079;
		server tunnel-streamer:3080;
		server tunnel-streamer:3081;
		server tunnel-streamer:3082;
		server tunnel-streamer:3083;
		server tunnel-streamer:3084;
		server tunnel-streamer:3085;
		server tunnel-streamer:3086;
		server tunnel-streamer:3087;
		server tunnel-streamer:3088;
		server tunnel-streamer:3089;
		server tunnel-streamer:3090;
		server tunnel-streamer:3091;
		server tunnel-streamer:3092;
		server tunnel-streamer:3093;
		server tunnel-streamer:3094;
		server tunnel-streamer:3095;
		server tunnel-streamer:3096;
		server tunnel-streamer:3097;
		server tunnel-streamer:3098;
		server tunnel-streamer:3099;
	}

	upstream sni_tcp_secured_backend
	{
		server tunnel-streamer:4000;
		server tunnel-streamer:4001;
		server tunnel-streamer:4002;
		server tunnel-streamer:4003;
		server tunnel-streamer:4004;
		server tunnel-streamer:4005;
		server tunnel-streamer:4006;
		server tunnel-streamer:4007;
		server tunnel-streamer:4008;
		server tunnel-streamer:4009;
		server tunnel-streamer:4010;
		server tunnel-streamer:4011;
		server tunnel-streamer:4012;
		server tunnel-streamer:4013;
		server tunnel-streamer:4014;
		server tunnel-streamer:4015;
		server tunnel-streamer:4016;
		server tunnel-streamer:4017;
		server tunnel-streamer:4018;
		server tunnel-streamer:4019;
		server tunnel-streamer:4020;
		server tunnel-streamer:4021;
		server tunnel-streamer:4022;
		server tunnel-streamer:4023;
		server tunnel-streamer:4024;
		server tunnel-streamer:4025;
		server tunnel-streamer:4026;
		server tunnel-streamer:4027;
		server tunnel-streamer:4028;
		server tunnel-streamer:4029;
		server tunnel-streamer:4030;
		server tunnel-streamer:4031;
		server tunnel-streamer:4032;
		server tunnel-streamer:4033;
		server tunnel-streamer:4034;
		server tunnel-streamer:4035;
		server tunnel-streamer:4036;
		server tunnel-streamer:4037;
		server tunnel-streamer:4038;
		server tunnel-streamer:4039;
		server tunnel-streamer:4040;
		server tunnel-streamer:4041;
		server tunnel-streamer:4042;
		server tunnel-streamer:4043;
		server tunnel-streamer:4044;
		server tunnel-streamer:4045;
		server tunnel-streamer:4046;
		server tunnel-streamer:4047;
		server tunnel-streamer:4048;
		server tunnel-streamer:4049;
		server tunnel-streamer:4050;
		server tunnel-streamer:4051;
		server tunnel-streamer:4052;
		server tunnel-streamer:4053;
		server tunnel-streamer:4054;
		server tunnel-streamer:4055;
		server tunnel-streamer:4056;
		server tunnel-streamer:4057;
		server tunnel-streamer:4058;
		server tunnel-streamer:4059;
		server tunnel-streamer:4060;
		server tunnel-streamer:4061;
		server tunnel-streamer:4062;
		server tunnel-streamer:4063;
		server tunnel-streamer:4064;
		server tunnel-streamer:4065;
		server tunnel-streamer:4066;
		server tunnel-streamer:4067;
		server tunnel-streamer:4068;
		server tunnel-streamer:4069;
		server tunnel-streamer:4070;
		server tunnel-streamer:4071;
		server tunnel-streamer:4072;
		server tunnel-streamer:4073;
		server tunnel-streamer:4074;
		server tunnel-streamer:4075;
		server tunnel-streamer:4076;
		server tunnel-streamer:4077;
		server tunnel-streamer:4078;
		server tunnel-streamer:4079;
		server tunnel-streamer:4080;
		server tunnel-streamer:4081;
		server tunnel-streamer:4082;
		server tunnel-streamer:4083;
		server tunnel-streamer:4084;
		server tunnel-streamer:4085;
		server tunnel-streamer:4086;
		server tunnel-streamer:4087;
		server tunnel-streamer:4088;
		server tunnel-streamer:4089;
		server tunnel-streamer:4090;
		server tunnel-streamer:4091;
		server tunnel-streamer:4092;
		server tunnel-streamer:4093;
		server tunnel-streamer:4094;
		server tunnel-streamer:4095;
		server tunnel-streamer:4096;
		server tunnel-streamer:4097;
		server tunnel-streamer:4098;
		server tunnel-streamer:4099;
	}

	server
	{
		listen 443;
		proxy_pass $backend;

		ssl_preread on;
		ssl_prefer_server_ciphers on;

		ssl_protocols TLSv1 TLSv1.1 TLSv1.2 SSLv3;
		ssl_session_cache builtin:1000 shared:SSL:50m;
		ssl_ciphers HIGH:!aNULL:!eNULL:!EXPORT:!CAMELLIA:!DES:!MD5:!PSK:!RC4;
		ssl_session_timeout 10m;

		ssl_certificate /ssl/nginx_ssl.crt;
		ssl_certificate_key /ssl/nginx_ssl.key;

		#set $sni $ssl_preread_server_name;
	}
}


http
{
	include mime.types;
	default_type application/octet-stream;
	sendfile on;
	keepalive_timeout 65;

	server
	{
		listen 6443 ssl;
		server_name localhost;
		http2 on;

		ssl_certificate /ssl/nginx_ssl.crt;
		ssl_certificate_key /ssl/nginx_ssl.key;

		location /nginx-status
		{
			add_header Content-Type text/plain;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			return 200 'welcome';
		}

		location /remote-view
		{
			alias /app/static/;
			index index.html;
			try_files $uri $uri/ /index.html;
		}
		
		location /api
		{
			proxy_pass http://tunnel-web:8000;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_http_version 1.1;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		# location /
		# {
		# 	proxy_pass https://streamer_tunnel_server_backend;
		# }

	}
}
